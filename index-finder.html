<!DOCTYPE html>
<html>
    <head>
        <style>
            #gridder > div {
                opacity: 0;
                background-color: gray;
            }


            #gridder > div:hover {
                opacity: 0.7
            }

            .hovering {
                opacity: 0.7 !important;
            }
        </style>
    </head>
    <body style="margin:0">
        <div style="position:absolute; left:0; top:0;">
            <div style="position:relative">
                <img src="../data/trus/labels/case10_10.png" alt="" id="shower">
                <div style="width: 512px; height: 512px; position:absolute; display: flex; flex-wrap: wrap; top:0; left:0;" id="gridder" width="512" height="512">
                    
                </div>
            </div>
            <div>
                <input type="text" id="name" value="case10_10" tabindex="1">
                <input type="text" id="dims" value="16 8" autofocus tabindex="2"><br>
                <input type="text" id="idx">
                <input type="text" id="coordx"><br>
                <input type="text" id="n_size" value="0">
                <input type="text" id="overlap" value="0">
            </div>
            <button id="change_img">Swap source</button>
        </div>
        <script>
            var elX = 0;
            var n_size = 0;
            var overlap = 0;
            var sourcetype = 'labels'

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            function imageExists(image_url){
                var http = new XMLHttpRequest();
                http.open('HEAD', image_url, false);
                http.send();
                return http.status != 404;
            }

            var width = 0;
            var height = 0;

            document.querySelector("#gridder").addEventListener("mouseover", (e) => {
                if (elX) {
                    elX.classList.remove('hovering');
                    elX = 0;
                }
            });

            document.querySelector("#dims").addEventListener("input", (e) => {
                var divs = []
                var gridder = document.querySelector("#gridder");
                gridder.innerHTML = "";

                res = e.target.value.split(" ");

                width = res[0]
                height = res[1]

                if (512 % height == 0 & 512 % width == 0 & width > 1 & height > 1) {
                    document.querySelector('#idx').value = '';
                    document.querySelector('#coordx').value = '';

                    for (var i = 0; i < (512 / width) * (512 / height); i++) {
                        var div = document.createElement('div');
                        div.id = 'subimg' + i
                        div.className = 'subimg'
                        div.style.width = width + 'px'
                        div.style.height = height + 'px'
                        div.style.display = 'inline-block'
                        div.style.flexShrink = '0'
                        div.style.verticalAlign = 'top'
                        div.style.position = 'relative';

                        var border_child = document.createElement('div');

                        border_child.style.top = '0px'
                        border_child.style.left = '0px';
                        border_child.style.position = 'absolute';
                        border_child.style.width = '100%';
                        border_child.style.height = '100%';
                        border_child.style.backgroundColor = 'grey';
                        border_child.style.zIndex = '-1';
                        border_child.style.pointerEvents = 'none';

                        div.appendChild(border_child);

                        div.addEventListener('mouseover', (e) => {
                            document.querySelector('#idx').value = e.target.id.replace('subimg', '');
                            document.querySelector('#coordx').value = e.target.getAttribute('coord-xy')
                        });
                        
                        gridder.appendChild(div)
                        divs.push(div)
                    }

                    for (var i = 0; i < (512 / width) * (512 / height); i++) {
                        var div = divs[i]

                        var bodyRect = document.body.getBoundingClientRect()
                        var elemRect = div.getBoundingClientRect()
                        var offsetY = elemRect.top - bodyRect.top;
                        var offsetX = elemRect.left - bodyRect.left;

                        div.setAttribute('coord-xy', offsetX + " " + offsetY);
                    }
                } else {
                    document.querySelector('#idx').value = 'invalid dims'
                    document.querySelector('#coordx').value = 'invalid dims'
                }
            });

            document.querySelector("#dims").dispatchEvent(new Event('input', {bubbles:true}));
            
            document.querySelector("#idx").addEventListener('keydown', e => {
                if (e.keyCode != 13) return;

                if (elX) {
                    elX.classList.remove('hovering');
                }

                var id = e.target.value;
                elX = document.querySelector('#subimg' + id);
                
                if (elX) {
                    elX.classList.add('hovering');

                    console.log(elX);
                }
            });
            
            document.querySelector("#n_size").addEventListener("keydown", e => {
                if (e.keyCode != 13) return;
                
                n_size = e.target.value
                var side_size = n_size * width * (1 - overlap);
                var peak_size = n_size * height * (1 - overlap);

                var style = `
                    #gridder > div:hover > div, #gridder > .hovering > div {
                        border-top: ${peak_size}px solid rgb(255, 255, 255, 0.5);
                        border-bottom: ${peak_size}px solid rgb(255, 255, 255, 0.5);
                        border-left: ${side_size}px solid rgb(255, 255, 255, 0.5);
                        border-right: ${side_size}px solid rgb(255, 255, 255, 0.5);
                        margin-top: -${peak_size}px;
                        margin-bottom: -${peak_size}px;
                        margin-left: -${side_size}px;
                        margin-right: -${side_size}px;
                    }
                `

                var styleSheet = document.createElement("style")
                styleSheet.innerText = style
                document.head.appendChild(styleSheet)
            });
            
            document.querySelector("#overlap").addEventListener("keydown", e => {
                if (e.keyCode != 13) return;
                
                overlap = e.target.value
                var side_size = n_size * width * (1 - overlap);
                var peak_size = n_size * height * (1 - overlap);

                var style = `
                    #gridder > div:hover > div, #gridder > .hovering > div {
                        border-top: ${peak_size}px solid rgb(255, 255, 255, 0.5);
                        border-bottom: ${peak_size}px solid rgb(255, 255, 255, 0.5);
                        border-left: ${side_size}px solid rgb(255, 255, 255, 0.5);
                        border-right: ${side_size}px solid rgb(255, 255, 255, 0.5);
                        margin-top: -${peak_size}px;
                        margin-bottom: -${peak_size}px;
                        margin-left: -${side_size}px;
                        margin-right: -${side_size}px;
                    }
                `

                var styleSheet = document.createElement("style")
                styleSheet.innerText = style
                document.head.appendChild(styleSheet)
            });

            document.querySelector("#coordx").addEventListener('keydown', e => {
                if (e.keyCode != 13) return;

                if (elX) {
                    elX.classList.remove('hovering')
                }

                var id = e.target.value;
                elX = document.querySelector('[coord-xy="' + e.target.value + '"]');
                
                if (elX) {
                    elX.classList.add('hovering');
                }
            });

            document.querySelector("#idx").addEventListener("input", (e) => {
                if (e.target.value == "" & elX) {
                    elX.classList.remove('hovering');
                }
            });

            document.querySelector("#coordx").addEventListener("input", (e) => {
                if (e.target.value == "" & elX) {
                    elX.classList.remove('hovering');
                }
            });

            document.querySelector("#name").addEventListener("input", (e) => {
                // document.querySelector('#idx').textContent = '';

                img_name = "../data/trus/" + sourcetype + "/" + e.target.value + '.png';

                if (imageExists(img_name)) {
                    document.querySelector("#shower").src = img_name
                }
            })
            
            document.querySelector("#change_img").addEventListener("click", (e) => {
                if (sourcetype == "labels") {
                    sourcetype = "images"
                } else {
                    sourcetype = "labels"
                }

                img_name = "../data/trus/" + sourcetype + "/" + document.querySelector("#name").value + '.png';
    
                if (imageExists(img_name)) {
                    document.querySelector("#shower").src = img_name
                }
            })
        </script>
    </body>
</html>